name: Translation Check

on:
  pull_request:
    branches:
      - main
      - master

jobs:
  check-translations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate translation keys
        shell: bash
        run: |
          echo "üîç Checking translation keys..."

          NO_DIR="src/languages/no"
          EN_DIR="src/languages/en"

          FOUND_KEYS=$(mktemp)
          MISSING=0

          # Extract all keys inside $t('...') or $t("...")
          grep -Rho "\$t\s*(\s*['\"][^'\"]*['\"]\s*)" src \
            | sed -E "s/.*\(['\"]([^'\"]*)['\"]\).*/\1/" \
            | sort | uniq > "$FOUND_KEYS"

          echo "Found translation keys:"
          cat "$FOUND_KEYS"
          echo ""

          while read -r KEY; do
              [[ -z "$KEY" ]] && continue

              FILE=$(echo "$KEY" | cut -d. -f1)
              SUBKEY=$(echo "$KEY" | cut -d. -f2-)

              NO_FILE="$NO_DIR/$FILE.json"
              EN_FILE="$EN_DIR/$FILE.json"

              # Ensure both translation files exist
              if [[ ! -f "$NO_FILE" ]]; then
                echo "‚ùå Missing NO file: $NO_FILE (for key $KEY)"
                MISSING=1
                continue
              fi
              if [[ ! -f "$EN_FILE" ]]; then
                echo "‚ùå Missing EN file: $EN_FILE (for key $KEY)"
                MISSING=1
                continue
              fi

              # Convert nested key a.b.c ‚Üí .a.b.c
              JQ_PATH=".$SUBKEY"

              # Validate NO key
              if ! jq -e "$JQ_PATH" "$NO_FILE" >/dev/null 2>&1; then
                echo "‚ùå Missing NO key: $FILE ‚Üí $SUBKEY"
                MISSING=1
              fi

              # Validate EN key
              if ! jq -e "$JQ_PATH" "$EN_FILE" >/dev/null 2>&1; then
                echo "‚ùå Missing EN key: $FILE ‚Üí $SUBKEY"
                MISSING=1
              fi

          done < "$FOUND_KEYS"

          rm "$FOUND_KEYS"

          if [[ $MISSING -eq 1 ]]; then
            echo ""
            echo "‚ùå Translation check failed."
            exit 1
          else
            echo "‚úÖ All translations exist!"
          fi
