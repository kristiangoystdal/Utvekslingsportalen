name: Translation Check

on:
  pull_request:
    branches:
      - main
      - master

jobs:
  check-translations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate translation keys
        shell: bash
        run: |
          echo "üîç Checking translation keys..."

          NO_DIR="src/languages/no"
          EN_DIR="src/languages/en"

          FOUND_KEYS=$(mktemp)
          MISSING=0

          # Extract all $t("key.path") or $t('key.path')
          # This safely extracts ONLY the content inside the quotes.
          grep -Rho "\$t\s*(\s*['\"][^'\"]*['\"]\s*)" src \
            | sed -E "s/.*\(['\"]([^'\"]*)['\"]\).*/\1/" \
            | sort | uniq > "$FOUND_KEYS"

          echo "Found keys:"
          cat "$FOUND_KEYS"
          echo ""

          while read -r KEY; do
              # Skip empty lines
              [[ -z "$KEY" ]] && continue

              FILE=$(echo "$KEY" | cut -d. -f1)
              SUBKEY=$(echo "$KEY" | cut -d. -f2-)

              NO_FILE="$NO_DIR/$FILE.json"
              EN_FILE="$EN_DIR/$FILE.json"

              # Check if translation file exists
              if [[ ! -f "$NO_FILE" ]]; then
                echo "‚ùå Missing Norwegian file: $NO_FILE (for key $KEY)"
                MISSING=1
                continue
              fi

              if [[ ! -f "$EN_FILE" ]]; then
                echo "‚ùå Missing English file: $EN_FILE (for key $KEY)"
                MISSING=1
                continue
              fi

              # Check if key exists in NO
              if ! jq -e ".$SUBKEY" "$NO_FILE" >/dev/null 2>&1; then
                echo "‚ùå Missing NO key: $FILE ‚Üí $SUBKEY"
                MISSING=1
              fi

              # Check if key exists in EN
              if ! jq -e ".$SUBKEY" "$EN_FILE" >/dev/null 2>&1; then
                echo "‚ùå Missing EN key: $FILE ‚Üí $SUBKEY"
                MISSING=1
              fi

          done < "$FOUND_KEYS"

          rm "$FOUND_KEYS"

          if [[ $MISSING -eq 1 ]]; then
            echo ""
            echo "‚ùå Translation check failed."
            exit 1
          else
            echo "‚úÖ All translations exist!"
          fi
